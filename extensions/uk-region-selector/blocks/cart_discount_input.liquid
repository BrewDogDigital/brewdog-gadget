{% comment %}
  MUP Discount Code Input for Cart Page
  Allows customers to apply discount codes directly on the cart page
{% endcomment %}

<style>
.mup-discount-input {
  margin: 1.5rem 0;
  padding: 1.5rem;
  background-color: var(--color-background-light, #f9fafb);
  border: 1px solid var(--color-border, #e5e7eb);
  border-radius: 0.5rem;
}

.mup-discount-input__header {
  margin-bottom: 1rem;
}

.mup-discount-input__title {
  font-size: 1rem;
  font-weight: 600;
  color: var(--color-text, #000);
  margin: 0 0 0.25rem 0;
}

.mup-discount-input__description {
  font-size: 0.875rem;
  color: var(--color-text-subdued, #6b7280);
  margin: 0;
}

.mup-discount-input__form {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.mup-discount-input__field {
  flex: 1;
  min-width: 200px;
  padding: 0.75rem 1rem;
  font-size: 1rem;
  border: 1px solid var(--color-border, #d1d5db);
  border-radius: 0.375rem;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.mup-discount-input__field:focus {
  outline: none;
  border-color: var(--color-primary, #000);
  box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
}

.mup-discount-input__field::placeholder {
  color: var(--color-text-placeholder, #9ca3af);
}

.mup-discount-input__button {
  padding: 0.75rem 1.5rem;
  font-size: 1rem;
  font-weight: 600;
  color: #fff;
  background-color: var(--color-button, #000);
  border: none;
  border-radius: 0.375rem;
  cursor: pointer;
  transition: opacity 0.2s;
  white-space: nowrap;
}

.mup-discount-input__button:hover {
  opacity: 0.9;
}

.mup-discount-input__button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.mup-discount-input__button--loading {
  position: relative;
}

.mup-discount-input__button--loading::after {
  content: '';
  position: absolute;
  width: 16px;
  height: 16px;
  top: 50%;
  left: 50%;
  margin-left: -8px;
  margin-top: -8px;
  border: 2px solid #fff;
  border-radius: 50%;
  border-top-color: transparent;
  animation: spinner 0.6s linear infinite;
}

@keyframes spinner {
  to { transform: rotate(360deg); }
}

.mup-discount-input__message {
  margin-top: 0.75rem;
  padding: 0.75rem 1rem;
  border-radius: 0.375rem;
  font-size: 0.875rem;
  line-height: 1.5;
}

.mup-discount-input__message--success {
  background-color: #d1fae5;
  color: #065f46;
  border: 1px solid #6ee7b7;
}

.mup-discount-input__message--error {
  background-color: #fee2e2;
  color: #991b1b;
  border: 1px solid #fca5a5;
}

.mup-discount-input__message--info {
  background-color: #dbeafe;
  color: #1e40af;
  border: 1px solid #93c5fd;
}

.mup-discount-input__applied {
  margin-top: 1rem;
  padding: 1rem;
  background-color: #d1fae5;
  border: 1px solid #6ee7b7;
  border-radius: 0.375rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.mup-discount-input__applied-info {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.mup-discount-input__applied-code {
  font-size: 0.875rem;
  font-weight: 600;
  color: #065f46;
}

.mup-discount-input__applied-savings {
  font-size: 0.75rem;
  color: #047857;
}

.mup-discount-input__remove {
  padding: 0.5rem 1rem;
  font-size: 0.875rem;
  color: #991b1b;
  background-color: transparent;
  border: 1px solid #fca5a5;
  border-radius: 0.375rem;
  cursor: pointer;
  transition: background-color 0.2s;
}

.mup-discount-input__remove:hover {
  background-color: #fee2e2;
}

@media (max-width: 640px) {
  .mup-discount-input__form {
    flex-direction: column;
  }
  
  .mup-discount-input__field,
  .mup-discount-input__button {
    width: 100%;
  }
  
  .mup-discount-input__applied {
    flex-direction: column;
    align-items: stretch;
    gap: 0.75rem;
  }
}
</style>

<div class="mup-discount-input" id="mup-discount-input" style="display: none;">
  <div class="mup-discount-input__header">
    <h3 class="mup-discount-input__title">
      {{ block.settings.title | default: "Have a discount code?" }}
    </h3>
    <p class="mup-discount-input__description">
      {{ block.settings.description | default: "Enter your code below to apply it to your order" }}
    </p>
  </div>

  <form class="mup-discount-input__form" id="mup-discount-form">
    <input
      type="text"
      class="mup-discount-input__field"
      id="mup-discount-code"
      name="discount_code"
      placeholder="{{ block.settings.placeholder | default: 'Enter discount code' }}"
      autocomplete="off"
      aria-label="Discount code"
    />
    <button
      type="submit"
      class="mup-discount-input__button"
      id="mup-discount-submit"
    >
      {{ block.settings.button_text | default: "Apply" }}
    </button>
  </form>

  <div id="mup-discount-message" class="mup-discount-input__message" style="display: none;"></div>
  
  <div id="mup-discount-applied" class="mup-discount-input__applied" style="display: none;">
    <div class="mup-discount-input__applied-info">
      <div class="mup-discount-input__applied-code" id="mup-applied-code"></div>
      <div class="mup-discount-input__applied-savings" id="mup-applied-savings"></div>
    </div>
    <button
      type="button"
      class="mup-discount-input__remove"
      id="mup-discount-remove"
    >
      Remove
    </button>
  </div>
</div>

<script>
(function() {
  'use strict';

  // Auto-inject into specified element if configured
  const autoInjectSelector = "{{ block.settings.auto_inject_selector }}";
  const injectPosition = "{{ block.settings.inject_position | default: 'prepend' }}";
  
  function handleAutoInjection() {
    const container = document.getElementById('mup-discount-input');
    
    // Only show if auto-inject selector is configured
    if (!autoInjectSelector || autoInjectSelector.trim() === '') {
      console.log('[MUP Discount Input] No auto-inject selector configured - keeping hidden');
      if (container) {
        container.style.display = 'none';
      }
      return;
    }
    
    console.log('[MUP Discount Input] Auto-inject selector:', autoInjectSelector);
    console.log('[MUP Discount Input] Inject position:', injectPosition);
    
    const targetElement = document.querySelector(autoInjectSelector);
    
    if (container && targetElement) {
      console.log('[MUP Discount Input] Target element found, injecting...');
      
      // Remove from current position
      container.remove();
      
      // Inject at specified position
      if (injectPosition === 'prepend') {
        targetElement.prepend(container);
      } else if (injectPosition === 'append') {
        targetElement.append(container);
      } else if (injectPosition === 'before') {
        targetElement.parentNode.insertBefore(container, targetElement);
      } else if (injectPosition === 'after') {
        targetElement.parentNode.insertBefore(container, targetElement.nextSibling);
      }
      
      // Show the container after successful injection
      container.style.display = 'block';
      
      console.log('[MUP Discount Input] Injected and made visible at:', autoInjectSelector);
    } else {
      if (!targetElement) {
        console.warn('[MUP Discount Input] Target element not found:', autoInjectSelector);
        console.warn('[MUP Discount Input] Discount input will remain hidden');
      }
    }
  }

  // Run auto-injection on load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', handleAutoInjection);
  } else {
    handleAutoInjection();
  }

  const form = document.getElementById('mup-discount-form');
  const input = document.getElementById('mup-discount-code');
  const submitBtn = document.getElementById('mup-discount-submit');
  const messageEl = document.getElementById('mup-discount-message');
  const appliedEl = document.getElementById('mup-discount-applied');
  const appliedCodeEl = document.getElementById('mup-applied-code');
  const appliedSavingsEl = document.getElementById('mup-applied-savings');
  const removeBtn = document.getElementById('mup-discount-remove');

  // Fetch override codes
  async function fetchOverrideCodes() {
    try {
      const response = await fetch('/apps/mup/override-codes.json');
      if (response.ok) {
        const data = await response.json();
        if (data.success && data.codes && data.codes.length > 0) {
          console.log('[MUP Discount] Fetched override codes from backend:', data.codes);
          return data.codes;
        }
      }
    } catch (error) {
      console.log('[MUP Discount] Could not fetch override codes, using defaults:', error);
    }

    // Fallback to hardcoded list - update this to match your configured codes
    console.log('[MUP Discount] Using hardcoded fallback list');
    return [
      'CS100',
      'STAFF40',
      'STAFF50',
      'INTERNAL',
      'OVERRIDE'
    ];
  }

  // Check if code is an override code and set cart attribute
  async function checkAndSetOverride(code) {
    const overrideCodes = await fetchOverrideCodes();
    const normalizedCode = code.toUpperCase().trim();
    const isOverride = overrideCodes.includes(normalizedCode);

    console.log('[MUP Discount] Code:', code, 'Is override:', isOverride);

    if (isOverride) {
      try {
        await fetch('/cart/update.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            attributes: {
              mup_override: 'true',
              _mup_override_set: new Date().toISOString()
            }
          })
        });
        console.log('[MUP Discount] Override attribute set');
        
        showMessage('✓ MUP enforcement bypassed - override code detected', 'info');
      } catch (error) {
        console.error('[MUP Discount] Failed to set override attribute:', error);
      }
    }
  }

  // Show message
  function showMessage(text, type = 'info') {
    messageEl.textContent = text;
    messageEl.className = `mup-discount-input__message mup-discount-input__message--${type}`;
    messageEl.style.display = 'block';
    
    if (type === 'success' || type === 'info') {
      setTimeout(() => {
        messageEl.style.display = 'none';
      }, 5000);
    }
  }

  // Apply discount code
  async function applyDiscount(code) {
    if (!code || code.trim() === '') {
      showMessage('Please enter a discount code', 'error');
      return;
    }

    try {
      submitBtn.disabled = true;
      submitBtn.classList.add('mup-discount-input__button--loading');
      submitBtn.textContent = 'Applying...';

      const normalizedCode = code.toUpperCase().trim();

      // First, save the discount code to cart attributes
      await fetch('/cart/update.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          attributes: {
            discount_code: normalizedCode,
            _discount_applied: new Date().toISOString()
          }
        })
      });

      // Check and set override if needed
      await checkAndSetOverride(code);

      // Apply discount using Shopify's native discount application
      // This sets a session cookie without redirecting
      await fetch(`/discount/${encodeURIComponent(normalizedCode)}`, {
        method: 'GET',
        credentials: 'same-origin'
      });
      
      // Small delay to let discount apply
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Reload the current page to show updated cart with discount
      window.location.reload();

    } catch (error) {
      console.error('[MUP Discount] Error applying discount:', error);
      showMessage('Failed to apply discount code. Please try again.', 'error');
      submitBtn.disabled = false;
      submitBtn.classList.remove('mup-discount-input__button--loading');
      submitBtn.textContent = '{{ block.settings.button_text | default: "Apply" }}';
    }
  }

  // Display applied discount
  function displayAppliedDiscount(code, cart) {
    appliedCodeEl.textContent = `Code: ${code.toUpperCase()}`;
    
    if (cart && cart.total_discount && cart.total_discount > 0) {
      const savings = (cart.total_discount / 100).toFixed(2);
      const currencySymbol = cart.currency ? '£' : '£'; // Default to £ or use cart.currency
      appliedSavingsEl.textContent = `You're saving ${currencySymbol}${savings}`;
    } else {
      appliedSavingsEl.textContent = 'Discount applied';
    }
    
    // Show applied state, hide form
    appliedEl.style.display = 'flex';
    form.style.display = 'none';
    messageEl.style.display = 'none';
  }

  // Remove discount
  async function removeDiscount() {
    try {
      removeBtn.disabled = true;
      removeBtn.textContent = 'Removing...';

      // Clear cart attributes
      await fetch('/cart/update.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          attributes: {
            discount_code: '',
            mup_override: '',
            _discount_removed: new Date().toISOString()
          }
        })
      });

      // Clear discount using Shopify's native endpoint
      await fetch('/discount/CLEAR', {
        method: 'GET',
        credentials: 'same-origin'
      });
      
      // Small delay to let discount clear
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Reload the current page to show updated cart without discount
      window.location.reload();

    } catch (error) {
      console.error('[MUP Discount] Error removing discount:', error);
      showMessage('Failed to remove discount. Please try again.', 'error');
      removeBtn.disabled = false;
      removeBtn.textContent = 'Remove';
    }
  }

  // Check for existing discount on page load
  async function checkExistingDiscount() {
    try {
      const cartResponse = await fetch('/cart.js');
      const cart = await cartResponse.json();

      console.log('[MUP Discount] Cart object:', cart);
      console.log('[MUP Discount] Cart attributes:', cart.attributes);
      console.log('[MUP Discount] Cart item count:', cart.item_count);

      // If cart is empty and discount exists, clear it
      if (cart.item_count === 0 && cart.attributes && cart.attributes.discount_code) {
        console.log('[MUP Discount] Cart is empty but discount exists - clearing discount');
        await fetch('/cart/update.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            attributes: {
              discount_code: '',
              mup_override: '',
              _discount_cleared: new Date().toISOString()
            }
          })
        });
        // Redirect to clear the discount from session
        window.location.href = '/discount/CLEAR?return_to=/cart';
        return;
      }

      // Check cart attributes for stored discount code (most reliable)
      let appliedCode = null;
      
      if (cart.attributes && cart.attributes.discount_code && cart.attributes.discount_code.trim() !== '') {
        appliedCode = cart.attributes.discount_code;
        console.log('[MUP Discount] Found discount in cart attributes:', appliedCode);
      }

      // Also check URL for discount parameter
      const urlParams = new URLSearchParams(window.location.search);
      const urlDiscount = urlParams.get('discount');
      if (urlDiscount && !appliedCode) {
        appliedCode = urlDiscount;
        console.log('[MUP Discount] Found discount in URL:', appliedCode);
      }

      if (appliedCode) {
        console.log('[MUP Discount] Displaying applied discount:', appliedCode);
        displayAppliedDiscount(appliedCode, cart);
        await checkAndSetOverride(appliedCode);
      } else {
        console.log('[MUP Discount] No discount code found, showing form');
        // Make sure form is visible and applied section is hidden
        form.style.display = 'flex';
        appliedEl.style.display = 'none';
      }

    } catch (error) {
      console.error('[MUP Discount] Error checking existing discount:', error);
    }
  }

  // Form submit handler
  if (form) {
    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const code = input.value.trim();
      applyDiscount(code);
    });
  }

  // Remove button handler
  if (removeBtn) {
    removeBtn.addEventListener('click', () => {
      removeDiscount();
    });
  }

  // Check for existing discount on load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', checkExistingDiscount);
  } else {
    checkExistingDiscount();
  }

})();
</script>

{% schema %}
{
  "name": "MUP Discount Input",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Auto-Injection Settings"
    },
    {
      "type": "paragraph",
      "content": "REQUIRED: Specify where to inject this discount input on the cart page. The input will only be visible if a valid CSS selector is provided."
    },
    {
      "type": "text",
      "id": "auto_inject_selector",
      "label": "Auto-inject CSS Selector (Required)",
      "info": "e.g., .cart__footer, #cart-total, .cart-drawer__footer - Where to inject the discount input. The block will remain hidden if no selector is provided.",
      "placeholder": ".cart__footer"
    },
    {
      "type": "select",
      "id": "inject_position",
      "label": "Injection Position",
      "options": [
        {
          "value": "prepend",
          "label": "Beginning of element (inside)"
        },
        {
          "value": "append",
          "label": "End of element (inside)"
        },
        {
          "value": "before",
          "label": "Before element (outside)"
        },
        {
          "value": "after",
          "label": "After element (outside)"
        }
      ],
      "default": "prepend",
      "info": "Choose whether to place inside or outside the target element"
    },
    {
      "type": "header",
      "content": "Content Settings"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Have a discount code?"
    },
    {
      "type": "text",
      "id": "description",
      "label": "Description",
      "default": "Enter your code below to apply it to your order"
    },
    {
      "type": "text",
      "id": "placeholder",
      "label": "Input Placeholder",
      "default": "Enter discount code"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Apply"
    }
  ]
}
{% endschema %}

